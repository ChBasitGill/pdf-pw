<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
      @media print {
        .page-break {
          page-break-after: always;
        }
        thead {
          display: table-header-group;
        }
        tr {
          page-break-inside: avoid;
        }
      }
      .line-path {
        fill: none;
        stroke: #009245;
        stroke-width: 2.5;
      }
      .area-path {
        fill: rgba(0, 146, 69, 0.1);
      }
      .tick text {
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body class="bg-white">
    <div class="p-10">
      <h1 class="text-4xl font-bold text-slate-800 mb-2">{{reportTitle}}</h1>
      <p class="text-slate-500 mb-10">{{summary}}</p>

      <div class="mb-12 p-6 border border-slate-200 rounded-xl bg-slate-50">
        <h3 class="text-lg font-bold text-slate-700 mb-6">
          Performance Trend (SVG Vector)
        </h3>
        <div id="svg-chart-container" class="w-full"></div>
      </div>

      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="border-b-2 border-green-600 bg-slate-100">
            <th class="p-3 text-sm font-bold uppercase">ID</th>
            <th class="p-3 text-sm font-bold uppercase">Description</th>
            <th class="p-3 text-sm font-bold uppercase text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          {{#each items}}
          <tr class="border-b border-slate-100">
            <td class="p-3 text-sm">#{{this.id}}</td>
            <td class="p-3 text-sm text-slate-600">{{this.description}}</td>
            <td class="p-3 text-sm text-right font-mono">${{this.amount}}</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>

    <script>
      // 1. Capture the Handlebars data into a JS variable
      // We use triple braces to avoid HTML escaping of the JSON string
      const reportData = {{{json items}}};

      // 2. D3 Chart Logic
      const container = document.getElementById('svg-chart-container');
      const width = container.offsetWidth || 800;
      const height = 300;
      const margin = {top: 20, right: 30, bottom: 40, left: 50};

      const svg = d3.select("#svg-chart-container")
          .append("svg")
          .attr("viewBox", `0 0 ${width} ${height}`)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

      // Scales
      const x = d3.scaleLinear()
          .domain([0, reportData.length - 1])
          .range([0, width - margin.left - margin.right]);

      const y = d3.scaleLinear()
          .domain([0, d3.max(reportData, d => parseFloat(d.amount)) * 1.1])
          .range([height - margin.top - margin.bottom, 0]);

      // Draw Area
      svg.append("path")
          .datum(reportData)
          .attr("class", "area-path")
          .attr("d", d3.area()
              .x((d, i) => x(i))
              .y0(y(0))
              .y1(d => y(parseFloat(d.amount)))
          );

      // Draw Line
      svg.append("path")
          .datum(reportData)
          .attr("class", "line-path")
          .attr("d", d3.line()
              .x((d, i) => x(i))
              .y(d => y(parseFloat(d.amount)))
          );

      // Add Axes
      svg.append("g")
          .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
          .call(d3.axisBottom(x).ticks(5).tickFormat(i => "Record " + i));

      svg.append("g")
          .call(d3.axisLeft(y).ticks(5));
    </script>
  </body>
</html>
